/**
 * Unit test for SecurityVulnerability model validation
 * This test MUST FAIL until the SecurityVulnerability model is implemented
 */

import { describe, it, expect } from 'vitest'
import { SecurityVulnerability } from '../../src/models/SecurityVulnerability'

describe('SecurityVulnerability Model Validation', () => {
  it('should create valid SecurityVulnerability with required fields', () => {
    // Arrange
    const vulnerabilityData = {
      id: 'CVE-2023-1234',
      severity: 'high' as const,
      affectedVersions: '<1.0.0',
      description: 'Critical security vulnerability in package',
      source: 'npm' as const,
      publishedDate: new Date('2023-01-01'),
      fixAvailable: true
    }

    // Act
    const vulnerability = new SecurityVulnerability(vulnerabilityData)

    // Assert
    expect(vulnerability.id).toBe('CVE-2023-1234')
    expect(vulnerability.severity).toBe('high')
    expect(vulnerability.affectedVersions).toBe('<1.0.0')
    expect(vulnerability.description).toBe('Critical security vulnerability in package')
    expect(vulnerability.source).toBe('npm')
    expect(vulnerability.publishedDate).toEqual(new Date('2023-01-01'))
    expect(vulnerability.fixAvailable).toBe(true)
  })

  it('should validate CVE ID format', () => {
    // Valid CVE IDs
    const validIds = [
      'CVE-2023-1234',
      'CVE-2024-123456',
      'CVE-1999-0001',
      'GHSA-abcd-efgh-ijkl',
      'GHSA-1234-5678-9012'
    ]

    for (const id of validIds) {
      expect(() => {
        new SecurityVulnerability({
          id,
          severity: 'high',
          affectedVersions: '*',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate: new Date(),
          fixAvailable: false
        })
      }).not.toThrow()
    }

    // Invalid CVE IDs
    const invalidIds = [
      '',
      'CVE-23-1234',
      'CVE-2023',
      'GHSA-abc',
      'GHSA-abcd-efgh',
      'invalid-id',
      'CVE-2023-ABCD'
    ]

    for (const id of invalidIds) {
      expect(() => {
        new SecurityVulnerability({
          id,
          severity: 'high',
          affectedVersions: '*',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate: new Date(),
          fixAvailable: false
        })
      }).toThrow()
    }
  })

  it('should validate severity levels', () => {
    // Valid severity levels
    const validSeverities = ['low', 'moderate', 'high', 'critical'] as const

    for (const severity of validSeverities) {
      expect(() => {
        new SecurityVulnerability({
          id: 'CVE-2023-1234',
          severity,
          affectedVersions: '*',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate: new Date(),
          fixAvailable: false
        })
      }).not.toThrow()
    }

    // Invalid severity
    expect(() => {
      new SecurityVulnerability({
        id: 'CVE-2023-1234',
        severity: 'medium' as any,
        affectedVersions: '*',
        description: 'Test vulnerability',
        source: 'npm',
        publishedDate: new Date(),
        fixAvailable: false
      })
    }).toThrow()
  })

  it('should validate source enum', () => {
    // Valid sources
    const validSources = ['npm', 'github', 'snyk', 'nvd'] as const

    for (const source of validSources) {
      expect(() => {
        new SecurityVulnerability({
          id: 'CVE-2023-1234',
          severity: 'high',
          affectedVersions: '*',
          description: 'Test vulnerability',
          source,
          publishedDate: new Date(),
          fixAvailable: false
        })
      }).not.toThrow()
    }

    // Invalid source
    expect(() => {
      new SecurityVulnerability({
        id: 'CVE-2023-1234',
        severity: 'high',
        affectedVersions: '*',
        description: 'Test vulnerability',
        source: 'custom' as any,
        publishedDate: new Date(),
        fixAvailable: false
      })
    }).toThrow()
  })

  it('should validate patched version format when provided', () => {
    // Valid patched versions
    const validVersions = [
      '1.0.1',
      '2.0.0',
      '1.0.0-alpha.1',
      '3.1.4-beta.2'
    ]

    for (const patchedVersion of validVersions) {
      expect(() => {
        new SecurityVulnerability({
          id: 'CVE-2023-1234',
          severity: 'high',
          affectedVersions: '<1.0.0',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate: new Date(),
          fixAvailable: true,
          patchedVersion
        })
      }).not.toThrow()
    }

    // Invalid patched versions
    const invalidVersions = [
      'v1.0.0',
      '1.0',
      'latest',
      'invalid'
    ]

    for (const patchedVersion of invalidVersions) {
      expect(() => {
        new SecurityVulnerability({
          id: 'CVE-2023-1234',
          severity: 'high',
          affectedVersions: '<1.0.0',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate: new Date(),
          fixAvailable: true,
          patchedVersion
        })
      }).toThrow()
    }
  })

  it('should require non-empty description', () => {
    // Valid description
    expect(() => {
      new SecurityVulnerability({
        id: 'CVE-2023-1234',
        severity: 'high',
        affectedVersions: '*',
        description: 'Valid description',
        source: 'npm',
        publishedDate: new Date(),
        fixAvailable: false
      })
    }).not.toThrow()

    // Empty description
    expect(() => {
      new SecurityVulnerability({
        id: 'CVE-2023-1234',
        severity: 'high',
        affectedVersions: '*',
        description: '',
        source: 'npm',
        publishedDate: new Date(),
        fixAvailable: false
      })
    }).toThrow()
  })

  it('should validate published date is reasonable', () => {
    // Valid dates
    const validDates = [
      new Date('2023-01-01'),
      new Date('2024-06-15'),
      new Date(), // Today
    ]

    for (const publishedDate of validDates) {
      expect(() => {
        new SecurityVulnerability({
          id: 'CVE-2023-1234',
          severity: 'high',
          affectedVersions: '*',
          description: 'Test vulnerability',
          source: 'npm',
          publishedDate,
          fixAvailable: false
        })
      }).not.toThrow()
    }

    // Future date should be invalid
    const futureDate = new Date()
    futureDate.setFullYear(futureDate.getFullYear() + 1)
    
    expect(() => {
      new SecurityVulnerability({
        id: 'CVE-2023-1234',
        severity: 'high',
        affectedVersions: '*',
        description: 'Test vulnerability',
        source: 'npm',
        publishedDate: futureDate,
        fixAvailable: false
      })
    }).toThrow()
  })

  it('should provide severity comparison methods', () => {
    const lowVuln = new SecurityVulnerability({
      id: 'CVE-2023-0001',
      severity: 'low',
      affectedVersions: '*',
      description: 'Low severity vulnerability',
      source: 'npm',
      publishedDate: new Date(),
      fixAvailable: false
    })

    const criticalVuln = new SecurityVulnerability({
      id: 'CVE-2023-0002',
      severity: 'critical',
      affectedVersions: '*',
      description: 'Critical vulnerability',
      source: 'npm',
      publishedDate: new Date(),
      fixAvailable: true
    })

    // Should provide severity comparison
    expect(lowVuln.getSeverityScore()).toBeLessThan(criticalVuln.getSeverityScore())
    expect(criticalVuln.isMoreSevereThan(lowVuln)).toBe(true)
    expect(lowVuln.isMoreSevereThan(criticalVuln)).toBe(false)
  })

  it('should determine if vulnerability is fixable', () => {
    const fixableVuln = new SecurityVulnerability({
      id: 'CVE-2023-1234',
      severity: 'high',
      affectedVersions: '<1.0.0',
      description: 'Fixable vulnerability',
      source: 'npm',
      publishedDate: new Date(),
      fixAvailable: true,
      patchedVersion: '1.0.1'
    })

    const unfixableVuln = new SecurityVulnerability({
      id: 'CVE-2023-5678',
      severity: 'critical',
      affectedVersions: '*',
      description: 'Unfixable vulnerability',
      source: 'npm',
      publishedDate: new Date(),
      fixAvailable: false
    })

    expect(fixableVuln.isFixable()).toBe(true)
    expect(fixableVuln.hasPatch()).toBe(true)
    expect(unfixableVuln.isFixable()).toBe(false)
    expect(unfixableVuln.hasPatch()).toBe(false)
  })

  it('should serialize to JSON correctly', () => {
    const vulnerability = new SecurityVulnerability({
      id: 'GHSA-abcd-efgh-ijkl',
      severity: 'critical',
      affectedVersions: '>=1.0.0 <1.2.3',
      description: 'Critical security issue requiring immediate attention',
      source: 'github',
      publishedDate: new Date('2024-01-15'),
      fixAvailable: true,
      patchedVersion: '1.2.3'
    })

    const json = vulnerability.toJSON()
    
    expect(json.id).toBe('GHSA-abcd-efgh-ijkl')
    expect(json.severity).toBe('critical')
    expect(json.affectedVersions).toBe('>=1.0.0 <1.2.3')
    expect(json.description).toBe('Critical security issue requiring immediate attention')
    expect(json.source).toBe('github')
    expect(json.publishedDate).toBe('2024-01-15T00:00:00.000Z')
    expect(json.fixAvailable).toBe(true)
    expect(json.patchedVersion).toBe('1.2.3')
  })

  it('should create from JSON correctly', () => {
    const jsonData = {
      id: 'CVE-2024-1234',
      severity: 'moderate',
      affectedVersions: '<2.0.0',
      description: 'Moderate vulnerability in dependency',
      source: 'nvd',
      publishedDate: '2024-01-01T00:00:00.000Z',
      fixAvailable: true,
      patchedVersion: '2.0.0'
    }

    const vulnerability = SecurityVulnerability.fromJSON(jsonData)
    
    expect(vulnerability.id).toBe('CVE-2024-1234')
    expect(vulnerability.severity).toBe('moderate')
    expect(vulnerability.publishedDate).toEqual(new Date('2024-01-01T00:00:00.000Z'))
    expect(vulnerability.fixAvailable).toBe(true)
    expect(vulnerability.patchedVersion).toBe('2.0.0')
  })

  it('should support filtering by date range', () => {
    const oldVuln = new SecurityVulnerability({
      id: 'CVE-2020-1234',
      severity: 'high',
      affectedVersions: '*',
      description: 'Old vulnerability',
      source: 'npm',
      publishedDate: new Date('2020-01-01'),
      fixAvailable: true
    })

    const recentVuln = new SecurityVulnerability({
      id: 'CVE-2024-5678',
      severity: 'critical',
      affectedVersions: '*',
      description: 'Recent vulnerability',
      source: 'npm',
      publishedDate: new Date('2024-01-01'),
      fixAvailable: false
    })

    const cutoffDate = new Date('2023-01-01')
    
    expect(oldVuln.isPublishedAfter(cutoffDate)).toBe(false)
    expect(recentVuln.isPublishedAfter(cutoffDate)).toBe(true)
    expect(recentVuln.isPublishedBefore(cutoffDate)).toBe(false)
    expect(oldVuln.isPublishedBefore(cutoffDate)).toBe(true)
  })
})